<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importar Tarefas Squad - AgilePulse</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen py-12">
    <div class="container mx-auto px-4">
        <div class="bg-white rounded-lg shadow-lg p-8 max-w-2xl mx-auto">
            <h1 class="text-3xl font-bold text-slate-900 mb-6">
                üìã Importar Tarefas Squad
            </h1>

            <div class="space-y-6">
                <!-- File Input -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        Arquivo JSON (tarefas_processadas.json)
                    </label>
                    <input
                        type="file"
                        id="jsonFile"
                        accept=".json"
                        class="block w-full text-sm text-slate-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-lg file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100"
                    />
                    <p id="fileName" class="mt-2 text-sm text-slate-600"></p>
                </div>

                <!-- Import Button -->
                <button
                    id="importBtn"
                    onclick="importTasks()"
                    disabled
                    class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-semibold"
                >
                    üöÄ Importar Tarefas
                </button>

                <!-- Progress -->
                <div id="progressContainer" class="hidden space-y-2">
                    <div class="w-full bg-slate-200 rounded-full h-2.5">
                        <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p id="progressText" class="text-sm text-center text-slate-600"></p>
                </div>

                <!-- Status -->
                <div id="statusContainer" class="hidden"></div>

                <!-- Instructions -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="font-semibold text-blue-900 mb-2">
                        üìã Como usar:
                    </h3>
                    <ol class="text-sm text-blue-800 space-y-1 list-decimal list-inside">
                        <li>Selecione o arquivo <code class="bg-blue-100 px-1 rounded">tarefas_processadas.json</code></li>
                        <li>Clique em "Importar Tarefas"</li>
                        <li>Aguarde a conclus√£o da importa√ß√£o</li>
                        <li>O template estar√° dispon√≠vel no sistema</li>
                    </ol>
                </div>

                <!-- Supabase Config -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h3 class="font-semibold text-yellow-900 mb-2">
                        ‚öôÔ∏è Configura√ß√£o Supabase:
                    </h3>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-xs font-medium text-yellow-800 mb-1">
                                Supabase URL:
                            </label>
                            <input
                                type="text"
                                id="supabaseUrl"
                                placeholder="https://seu-projeto.supabase.co"
                                class="w-full px-3 py-2 text-sm border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                            />
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-yellow-800 mb-1">
                                Supabase Anon Key:
                            </label>
                            <input
                                type="password"
                                id="supabaseKey"
                                placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                                class="w-full px-3 py-2 text-sm border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                            />
                        </div>
                        <p class="text-xs text-yellow-700">
                            üí° Encontre essas informa√ß√µes em: Supabase Dashboard ‚Üí Settings ‚Üí API
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        let selectedFile = null;

        // File input handler
        document.getElementById('jsonFile').addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                selectedFile = e.target.files[0];
                document.getElementById('fileName').textContent = `Arquivo selecionado: ${selectedFile.name}`;
                document.getElementById('importBtn').disabled = false;
            }
        });

        async function importTasks() {
            if (!selectedFile) {
                alert('Por favor, selecione um arquivo JSON');
                return;
            }

            const supabaseUrl = document.getElementById('supabaseUrl').value.trim();
            const supabaseKey = document.getElementById('supabaseKey').value.trim();

            if (!supabaseUrl || !supabaseKey) {
                alert('Por favor, configure as credenciais do Supabase');
                return;
            }

            // Criar cliente Supabase
            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

            // UI Updates
            document.getElementById('importBtn').disabled = true;
            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('statusContainer').classList.add('hidden');
            document.getElementById('statusContainer').innerHTML = '';

            try {
                // Ler arquivo JSON
                const text = await selectedFile.text();
                const data = JSON.parse(text);

                updateProgress(5, `Carregado: ${data.totalTasks} tarefas`);

                // Criar template
                const { data: templateData, error: templateError } = await supabase
                    .from('task_templates')
                    .insert({
                        name: 'Tarefas Squad',
                        description: `Template importado do arquivo "${selectedFile.name}" em ${new Date().toISOString()}. Cont√©m ${data.totalTasks} tarefas principais.`,
                        created_by: null
                    })
                    .select()
                    .single();

                if (templateError) throw new Error(`Erro ao criar template: ${templateError.message}`);

                updateProgress(10, `Template criado: ${templateData.name}`);

                // Criar tarefas
                let createdTasks = 0;
                let createdActivities = 0;

                for (let i = 0; i < data.tasks.length; i++) {
                    const task = data.tasks[i];

                    const { data: taskData, error: taskError } = await supabase
                        .from('template_tasks')
                        .insert({
                            template_id: templateData.id,
                            title: task.title,
                            description: `Tarefa ${task.number}`,
                            priority: 'M√©dia'
                        })
                        .select()
                        .single();

                    if (!taskError) {
                        createdTasks++;

                        // Criar atividades
                        if (task.subtasks && task.subtasks.length > 0) {
                            for (const subtask of task.subtasks) {
                                const { error: activityError } = await supabase
                                    .from('template_activities')
                                    .insert({
                                        template_task_id: taskData.id,
                                        title: subtask
                                    });

                                if (!activityError) createdActivities++;
                            }
                        }
                    }

                    const progress = 10 + ((i + 1) / data.totalTasks) * 90;
                    updateProgress(Math.round(progress), `Criando tarefas: ${createdTasks}/${data.totalTasks}`);
                }

                updateProgress(100, 'Importa√ß√£o conclu√≠da!');

                // Show success
                showStatus('success', `
                    <p class="font-medium">‚úÖ Importa√ß√£o conclu√≠da com sucesso!</p>
                    <div class="mt-2 text-sm space-y-1">
                        <p>‚Ä¢ Template: ${templateData.name} (ID: ${templateData.id})</p>
                        <p>‚Ä¢ Tarefas criadas: ${createdTasks}/${data.totalTasks}</p>
                        <p>‚Ä¢ Atividades criadas: ${createdActivities}</p>
                        <p class="mt-2 font-medium">üéâ Acesse: Configura√ß√µes ‚Üí Modelos ‚Üí "Tarefas Squad"</p>
                    </div>
                `);

            } catch (error) {
                showStatus('error', `‚ùå Erro: ${error.message}`);
                console.error('Erro na importa√ß√£o:', error);
            } finally {
                document.getElementById('importBtn').disabled = false;
            }
        }

        function updateProgress(percent, message) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${percent}% - ${message}`;
        }

        function showStatus(type, html) {
            const container = document.getElementById('statusContainer');
            const bgColor = type === 'success' ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800';
            container.innerHTML = `<div class="${bgColor} p-4 rounded-lg">${html}</div>`;
            container.classList.remove('hidden');
        }
    </script>
</body>
</html>
